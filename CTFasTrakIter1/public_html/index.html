<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title></title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            #map {
                height: 600px;
                width: 80%;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
	
	<form name = "userInput">
	  <table>
		<tr>
	      <td>Enter current location:</td>
		  <td> <input type=text name=start size=30> <td>
		  <td><input type=button value="GO!" onClick="displayUserStartStopLoc()"></td>
		</tr>
		<tr>
		  <td>Enter destination location:</td>
		  <td><input type=text name=end size=30></td>	
                  <td></td>
                </tr>
                <tr>
		  <td>Enter a search radius</td>
		  <td><input type=text name=radius size=30><td>
		  <td><input type=button value="save radius" onClick="setRadius()"></td>
                </tr>		
                <tr>
		  <td><input type=button value="See All Busses" onClick="displayAllBusses()"></td>
                  <td><input type=button value="View Close Busses" onClick="displayCloseBussesToStart()"></td>
		  <td><input type=button value="View Close Stops" onClick="displayCloseStopsToStart()"></td>
                </tr>
		<tr>
		  <td><input type=button value="forTesting" onClick="test()"></td>
		  <td></td>				
  	    </tr>
	    <tr>
	    </tr>
	  </table>
	</form>
	
	<p id="testing"> </p>
        
        <script>
		var theMap;  //global
		var centerLatLng;
		var radius;
		var start;
		var end;
	
		function test(){
		  displayCloseStops(start, radius);		  
		}
	
	  	function initMap() {
		  centerLatLng = new google.maps.LatLng(41.635768, -72.787725);
		  theMap = new google.maps.Map(document.getElementById('map'), {
		    zoom: 9,
		    center: centerLatLng,
		    mapTypeId: 'terrain' 
		  }); 
	        }
		
		
	        //String fileName must be one of ["agency", "calendar", "calendar_dates", "routes", "shapes", "stop_times", "stops", "trips"]
	        //will return an object containing 
	        function readStaticData(fileName){
		  var req = new XMLHttpRequest();
		  req.open('GET', 'https://raw.githubusercontent.com/jmluczy/TBDs-CTFasTrak-Project/static-data/version1/CTFasTrakStaticData/' + fileName + 'JSON.txt', false);
		  req.send(null);
		
		  if(req.status == 200){
		    var jsonString = req.responseText;		
		    var dataObj = JSON.parse(jsonString);     

		    return dataObj;
		  }
	        }
		
		//n must be an integer 0, 1, 2, 3 to indicate which of the live data streams to access
	        //will return an object containing the data from the feed specified
		function readRealTimeData(n){
		  var feedType = ['tripupdate/tripupdates', 'vehicle/vehiclepositions', 'alert/alerts', 'externalfeed/trapezerealtimefeed'];
		  var req = new XMLHttpRequest();
		  req.open('GET', 'http://65.213.12.244/realtimefeed/' + feedType[n] + '.json', false);
		  req.send(null);
		
		  if(req.status == 200){
		    var rawString = req.responseText;	
		    var dataObj = JSON.parse(rawString);
		    return dataObj;
		  }
	        }
		
		function displayUserStartStopLoc(){
		  start = document.userInput.start.value;
		  end   = document.userInput.end.value;
		  if (start !== ""){ //if user entered something
		    var startGeoCode = getGeoCode(start);
		      var pos = new google.maps.LatLng(startGeoCode.results[0].geometry.location.lat,
                                              startGeoCode.results[0].geometry.location.lng); //latitude longitude position
		      addMarker(pos, "START");
		      start = pos;
		  }
		  if (end !== ""){
		    var endGeoCode = getGeoCode(end);
		      var pos = endGeoCode.results[0].geometry.location; //latitude longitude position
		      addMarker(pos, "END");
		      end = pos;
		  }
		}
		
		function getGeoCode(address){  
		  address = address.replace(" ", "+");
		  var req = new XMLHttpRequest();
		  req.open('GET', 'https://maps.googleapis.com/maps/api/geocode/json?address=' + address 
						+ '&key=AIzaSyBezkqLyMpXAF9dBb4X5rZeQkyF8Y5_Te4', false);
		  req.send(null);
		
		  if(req.status == 200){
		    var rawString = req.responseText;
		    var geoData = JSON.parse(rawString);
		  }
		  
		  return geoData;
		}
		
		function update(message){
		  var text = document.getElementById("testing").innerHTML;
		  text = text + "<br>" + message;
		  document.getElementById("testing").innerHTML = text;
	        }
		
		function addMarker(latLng, labelText){
		  new google.maps.Marker({
		    map: theMap,
			label: labelText,
			position: latLng
		  });
		}
		
		function setRadius(){
		  radius = document.userInput.radius.value * 1; //cast type to number
		}
		
                function distance(pos1, pos2){  
	        //both pos1 must be LatLng objects i.e. {lat: double, lng: double}
		  var dist = google.maps.geometry.spherical.computeDistanceBetween(pos1, pos2); //in meters
		  dist = dist / 1609.34; //convert to miles
		  return dist;
	        }
		
		function displayAllBusses(){
	          var data = readRealTimeData(1).entity; //1 := vehicle positions
	          for (i = 0; i < data.length; i++){
	            new google.maps.Marker({
		      map: theMap,
		      position: new google.maps.LatLng( data[i].vehicle.position.latitude*1, data[i].vehicle.position.longitude*1),
		      label: data[i].id,
                      title: data[i].vehicle.trip.trip_id
		    });
	          }		  
	        }
		
		function displayCloseBussesToStart(){
		  displayCloseBusses(start, radius);
		}
		
		function displayCloseBusses(center, r){
		//displays all busses that are within 'r' miles of 'center'
		  var data = readRealTimeData(1).entity;
		  var pos, marker;
		  for (i = 0; i < data.length; i++){
	            pos = new google.maps.LatLng(data[i].vehicle.position.latitude*1, data[i].vehicle.position.longitude*1);
		    if (distance(center, pos) < r){
                      addBusMarker(data[i], pos);
                    }                    
    	          }			
		}
                
                function addBusMarker(bus, pos){                    
                  marker = new google.maps.Marker({
		        map: theMap,
		        position: pos,
		        label: "BUS",
                        title: bus.id
		    });
                  marker.addListener('click', function(){
                    theMap.setCenter(marker.getPosition()); 
                  });
                }
		
                function displayAllStops(){
                  data = readStaticData("stops");
                  for (i = 0; i < data.length; i++){
                    new google.maps.Marker({
                      map: theMap,
                      position: new google.maps.LatLng(data[i].stop_lat *1, data[i].stop_lon*1),
                      label: "BS",
                      title: data[i].stop_id
                    });   
                  }                    
                }
                
                function displayCloseStopsToStart(){
                  displayCloseStops(start, radius);
                }
                
                function displayCloseStops(center, r){    
                  data = readStaticData("stops"); 
                  var pos;
                  for (i = 0; i < data.length; i++){
                    pos = new google.maps.LatLng(data[i].stop_lat*1, data[i].stop_lon*1);
                    if ( distance(center, pos) < r){
                      new google.maps.Marker({
                        map: theMap,
                        position: pos,
                        label: "BS", 
                        title: data[i].stop_id
                      });  
                    }
                  }    
                }
		
		

		
		
	</script>
	
	<script async defer
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBezkqLyMpXAF9dBb4X5rZeQkyF8Y5_Te4&libraries=geometry&callback=initMap">
	</script>
    </body>
</html>
