<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title></title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            #map {
                height: 600px;
                width: 80%;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
	
	<form name = "userInput">
	  <table>
		<tr>
	      <td>Enter current location:</td>
		  <td> <input type=text name=start size=30> <td>
		  <td><input type=button value="GO!" onClick="displayUserStartStopLoc()"></td>
		</tr>
		<tr>
		  <td>Enter destination location:</td>
		  <td><input type=text name=end size=30></td>	
                  <td></td>
                </tr>
                <tr>
		  <td>Enter a search radius</td>
		  <td><input type=text name=radius size=30><td>
		  <td><input type=button value="save radius" onClick="setRadius()"></td>
                </tr>		
                <tr>
		  <td><input type=button value="View All Busses" onClick="displayAllBusses()"></td>
                  <td><input type=button value="View Close Busses" onClick="displayCloseBussesToStart()"></td>
		  <td><input type=button value="View Close Stops" onClick="displayCloseStopsToStart()"></td>
                </tr>
		<tr>
		  <td><input type=button value="for testing" onClick="test()"></td>
		  <td><input type=button value="View All Stops" onClick="displayAllStops()"></td>				
  	    </tr>
	    <tr>
	    </tr>
	  </table>
	</form>
	
	<p id="testing"> </p>
        
        <script>
		var theMap;  
                var transitLayer;
		var centerLatLng; //LatLng center of map LatLng
		var radius;       //user entered radius
		var start;        //LatLng user enterd start location 
                var allStops;     //holds data from "stops.txt" for all stops as a JSON object
		var end;          //LatLng user entered end location
                var infowindow;
        
		function test(){
		}
	
	  	function initMap() {
		  centerLatLng = new google.maps.LatLng(41.635768, -72.787725);
		  theMap = new google.maps.Map(document.getElementById('map'), {
		    zoom: 9,
		    center: centerLatLng,
		    mapTypeId: 'terrain' 
		  }); 
                  showPlaces();
	        }
                
                  function showPlaces(center, r){
                    infowindow = new google.maps.InfoWindow();
                    var service = new google.maps.places.PlacesService(theMap);
                    update("PlacesService object created");
                    service.nearbySearch({
                      location: center,
                      radius: r,
                      type: ['store']
                    }, callback);
                  }

                  function callback(results, status) {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                      for (var i = 0; i < results.length; i++) {
                        createMarker(results[i]);
                      }
                    }
                  }

                  function createMarker(place) {
                    var marker = new google.maps.Marker({
                      map: theMap,
                      position: place.geometry.location
                    });

                    google.maps.event.addListener(marker, 'click', function() {
                      infowindow.setContent(place.name);
                      infowindow.open(theMap, this);
                    });
                  }
                
                function getAllStops(){
                  if (allStops === undefined)
                    allStops = readStaticData("stops");
                  return allStops;
                }	
		
	        //String fileName must be one of ["agency", "calendar", "calendar_dates", "routes", "shapes", "stop_times", "stops", "trips"]
	        //will return an object containing 
	        function readStaticData(fileName){
		  var req = new XMLHttpRequest();
		  req.open('GET', 'https://raw.githubusercontent.com/jmluczy/TBDs-CTFasTrak-Project/static-data/version1/CTFasTrakStaticData/' + fileName + 'JSON.txt', false);
		  req.send(null);
		
		  if(req.status === 200){
		    var jsonString = req.responseText;		
		    var dataObj = JSON.parse(jsonString);     

		    return dataObj;
		  }
	        }
		
		//n must be an integer 0, 1, 2, 3 to indicate which of the live data streams to access
	        //will return an object containing the data from the feed specified
		function readRealTimeData(n){
		  var feedType = ['tripupdate/tripupdates', 'vehicle/vehiclepositions', 'alert/alerts', 'externalfeed/trapezerealtimefeed'];
		  var req = new XMLHttpRequest();
		  req.open('GET', 'http://65.213.12.244/realtimefeed/' + feedType[n] + '.json', false);
		  req.send(null);
		
		  if(req.status === 200){
		    var rawString = req.responseText;	
		    var dataObj = JSON.parse(rawString);
		    return dataObj;
		  }
	        }
		
		function displayUserStartStopLoc(){
		  start = document.userInput.start.value;
		  end   = document.userInput.end.value;
		  if (start !== ""){ //if user entered something
		    var startGeoCode = getGeoCode(start);
		      var pos = new google.maps.LatLng(startGeoCode.results[0].geometry.location.lat,
                                              startGeoCode.results[0].geometry.location.lng); //latitude longitude position
		      addMarker(pos, "START");
		      start = pos;
		  }
		  if (end !== ""){
		    var endGeoCode = getGeoCode(end);
		      var pos = endGeoCode.results[0].geometry.location; //latitude longitude position
		      addMarker(pos, "END");
		      end = pos;
		  }
		}
		
		function getGeoCode(address){
                //geocodes an address string returns the geocode JSON array
		  address = address.replace(" ", "+");
		  var req = new XMLHttpRequest();
		  req.open('GET', 'https://maps.googleapis.com/maps/api/geocode/json?address=' + address 
						+ '&key=AIzaSyBezkqLyMpXAF9dBb4X5rZeQkyF8Y5_Te4', false);
		  req.send(null);
		
		  if(req.status === 200){
		    var rawString = req.responseText;
		    var geoData = JSON.parse(rawString);
		  }		  
		  return geoData;
		}
		
		function update(message){
                //only purpose of this method is to aid in tracing. 
                //prints the argument message at the bottom of the webpage.
		  var text = document.getElementById("testing").innerHTML;
		  text = text + "<br>" + message;
		  document.getElementById("testing").innerHTML = text;
	        }
		
		function addMarker(latLng, labelText){
                //adds a marker with the provided LatLng object
		  new google.maps.Marker({
		    map: theMap,
                    label: labelText,
		    position: latLng
		  });
		}
		
		function setRadius(){ //called on button push
                //stores user entered radius in the global variable radius
		  radius = document.userInput.radius.value * 1; //cast type to number
		}
		
                function distance(pos1, pos2){  
                //returns distance (in miles) between the two positions entered
	        //both pos1 must be LatLng objects i.e. {lat: double, lng: double}
		  var dist = google.maps.geometry.spherical.computeDistanceBetween(pos1, pos2); //in meters
		  dist = dist / 1609.34; //convert to miles
		  return dist;
	        }
		
		function displayAllBusses(){
                  displayCloseBusses(centerLatLng, 10000);
	        }
		
		function displayCloseBussesToStart(){
		  displayCloseBusses(start, radius);
		}
		
		function displayCloseBusses(center, r){
		//displays all busses that are within 'r' miles of 'center'
                //'center' is a LatLng object
		  var data = readRealTimeData(1).entity;
		  var pos;
		  for (i = 0; i < data.length; i++){
	            pos = new google.maps.LatLng(data[i].vehicle.position.latitude*1, data[i].vehicle.position.longitude*1);
		    if (distance(center, pos) < r){
                      addBusMarker(data[i], pos);
                    }                    
    	          }			
		}
                
                function addBusMarker(bus, pos){
                //'bus' must be an element of the vehicle positions live feed array
                //'pos' is the bus's position as a LatLng object
                  marker = new google.maps.Marker({
		        map: theMap,
		        position: pos,
		        label: "Bus",
                        busId: bus.id,
                        tripId: bus.vehicle.trip.trip_id,
                        routeId: bus.vehicle.trip.route_id,
                        title: bus.id
		    });
                    
                  marker.addListener('click', function(){
                    //I know this is messy
                    var busStop, trip, pos;
                    var id = this.tripId;   //tripId of the Marker that was clicked
                    var tripData = readRealTimeData(0).entity;
                    var i = 0;
                    //find the trip update that matches the trip id of the clicked bus
                    while (id !== tripData[i].id) i++; 

                    //this is the trip update we are interested in
                    trip = tripData[i].trip_update.stop_time_update;

                    i = 0;
                    //skip the stops that the bus has already stopped at
                    while (trip[i].departure === null) i++;
                    
                    for (j = i; j < trip.length; j++){
                      busStop = getStopDataById(trip[j].stop_id);
                      pos = new google.maps.LatLng(busStop.stop_lat*1, busStop.stop_lon*1);
                      addStopMarker(busStop, pos);
                    }
                  });
                }
                //function displayStopsOfBus()
                
                function displayAllStops(){
                  displayCloseStops(centerLatLng, 1000);          
                }
                
                function displayCloseStopsToStart(){
                  displayCloseStops(start, radius);
                }
                
                function displayCloseStops(center, r){
                  var data = getAllStops();
                  var pos;
                  for (i = 0; i < data.length; i++){
                    pos = new google.maps.LatLng(data[i].stop_lat*1, data[i].stop_lon*1);
                    if ( distance(center, pos) < r){
                      addStopMarker(data[i], pos);
                    }
                  }    
                }
                
                function addStopMarker(stop, pos){
                  var marker = new google.maps.Marker({
                    map: theMap,
                    position: pos,
                    label: stop.stop_id,
                    title: stop.stop_id
                  });
                  marker.addListener('click', function(){
                    showPlaces(this.position, 500);
                  });
                }
		
		function getStopDataById(id){
                  var stops = getAllStops();
                  for (i = 0; i < stops.length; i++){
                    if (stops[i].stop_id === id)
                      return stops[i];
                  }
                }
	
               

                function createMarker(place) {
                  var placeLoc = place.geometry.location;
                  var marker = new google.maps.Marker({
                    map: theMap,
                    position: placeLoc
                  });

                  google.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent(place.name);
                    infowindow.open(theMap, this);
                  });
                }
                
                

          
	</script>
	
	<script async defer
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBezkqLyMpXAF9dBb4X5rZeQkyF8Y5_Te4&libraries=geometry&callback=initMap">
	</script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD_9mrVl2c6FS59KEwhm5L55R08fcuF_V0&libraries=places&callback=initMap" async defer></script>
    </body>
</html>
